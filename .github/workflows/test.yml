name: Test Server Health Status Page

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    strategy:
      fail-fast: false
      matrix:
        include:

          - os: windows-latest
            php-version: 'latest'
          
        
    runs-on: ${{ matrix.os }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up PHP
      uses: shivammathur/setup-php@v2
      if: ${{ matrix.php-version != 'smoke-test' }}
      with:
        php-version: ${{ matrix.php-version }}

    - name: Start PHP Server
      run: |
        php -S localhost:8000 -t . 

    - name: Run Curl to test endpoint
      run: |
        curl localhost:8000
        curl -sS http://localhost:8000/index.php | tee result.json
        cat result.json

    - name: Validate response
      run: |
        php -r '
        $response = json_decode(file_get_contents("result.json"), true);
        if ($response["statusCode"] !== 200) {
          echo "Status code is not 200";
          exit(1);
        }
        if ($response["statusMessage"] !== "OK") {
          echo "Status message is not OK";
          exit(1);
        }
        if (!isset($response["server_time"])) {
          echo "Server time is not set";
          exit(1);
        }
        echo "All checks passed!";
        '
